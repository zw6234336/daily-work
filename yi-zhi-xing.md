2017年12月21日 20:34:25

两阶段提交2PC\(Two Phase Commit\)

大部分数据库现在使用的协议是

**阶段一：提交事务申请**

1、事务询问 ：协调者向参与者发送事务内容，询问是否可移植性事务提交操作，并开始等待参与者相应

2、执行事务：参与者执行事务并记录事务执行结果

3、参与者向协调者反馈事务询问的相应：执行成功的返回yesy,执行失败的返回no

**阶段二：执行事务提交（投票）**

1. 发送提交请求：如果所有的参与者反馈的都是yes 。协调者向参与者发送commint命令
2. 事务提交：参与者接收到commit请求后。正式执行事务并释放事务执行期间锁占用的资源
3. 反馈事务提交结构：参与者完成事务提交后，向协调者发送Ack消息
4. 完成事务：协调者接收到所有Ack完成事务

**中断事务**

1. 发送回滚请求：参与者反馈No 或者等待超时，协调者会中断事务
2. 事务回滚：参与者接收到Rollback请求后利用记录的Undo信息来执行事务的回滚，并释放资源
3. 反馈事务回滚结果：参与者完成事务回滚，向协调者发送Ack消息
4. 中断事务：协调者接收到所有的参与着反馈Ack消息后中断事务

**总结**

两阶段事务将事务分成两个部分，投票和执行。每个事务都尝试了提交处理。因此两阶段事务被称为强一致性算法。

**优点：简单 实现方便**

**缺点：同步阻塞（所有参与事务的逻辑必须等待其他参与者相应）。单点问题（主要是协调者出现问题导致所有参与者无法释放资源）。数据不一致（参与者接收commit操作可能出现不一致情况）。所有的异常处理只能被动的等待超时**

